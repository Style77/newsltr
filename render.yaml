databases:
  - name: newsltr-db
    plan: free
    region: frankfurt
    databaseName: newsltr
    user: newsltr

services:
  - type: web
    name: newsltr-api
    runtime: docker
    region: frankfurt
    plan: free
    rootDir: newsltr
    dockerfilePath: prod.Dockerfile
    healthCheckPath: /api/v1/health?format=json
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: newsltr-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: newsltr-redis
          property: connectionString
      - key: DJANGO_SECRET_KEY
        generateValue: true
      - key: WEB_CONCURRENCY
        value: 4
      - key: PYTHON_VERSION
        value: 3.11.3
      - key: DJANGO_DEVELOPMENT
        value: false

      - key: EMAIL_HOST
        sync: false
      - key: EMAIL_HOST_USER
        sync: false
      - key: EMAIL_HOST_PASSWORD
        sync: false
      - key: SENDINBLUE_API_KEY
        sync: false

      - key: GOOGLE_OAUTH2_KEY
        sync: false
      - key: GOOGLE_OAUTH2_SECRET
        sync: false
  - type: web
    name: newsltr-web
    env: node
    plan: free
    region: frankfurt
    buildCommand: npm; npm run build
    startCommand: npm run start
    rootDir: client
    envVars:
      - key: NODE_ENV
        value: production
      - key: API_URL
        fromService:
          type: web
          name: newsltr-api
          property: hostport
  - type: redis
    name: newsltr-redis
    region: frankfurt
    plan: free
    ipAllowList:
      - source: 0.0.0.0/0  # todo change to service hostport
        description: Allow all incoming traffic
    maxmemoryPolicy: volatile-lru